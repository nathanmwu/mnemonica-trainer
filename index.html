<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mnemonica Stack Trainer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 100%;
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .nav-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            background: #f0f0f0;
            color: #666;
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .mode-content {
            display: none;
        }

        .mode-content.active {
            display: block;
        }

        .card-display {
            background: white;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .card-display:hover {
            transform: translateY(-5px);
        }

        .position-number {
            font-size: 72px;
            font-weight: bold;
            color: #667eea;
        }

        .playing-card {
            font-size: 120px;
            line-height: 1;
        }

        .card-value {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .suit {
            font-size: 80px;
        }

        .rank {
            font-size: 60px;
            font-weight: bold;
        }

        .red { color: #e74c3c; }
        .black { color: #2c3e50; }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .control-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: #667eea;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .control-btn:hover {
            background: #764ba2;
        }

        .settings {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .setting-row:last-child {
            margin-bottom: 0;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 30px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #667eea;
        }

        input:checked + .slider:before {
            transform: translateX(30px);
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .input-btn {
            padding: 15px;
            border: 2px solid #667eea;
            border-radius: 10px;
            background: white;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .input-btn:hover {
            background: #667eea;
            color: white;
        }

        .input-btn.selected {
            background: #667eea;
            color: white;
        }

        .timer {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 20px;
        }

        .stats-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            font-weight: 600;
            color: #495057;
        }

        .stat-value {
            color: #667eea;
            font-weight: bold;
        }

        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 10px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            width: 0%;
            transition: width 0.3s;
        }

        .feedback {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 600;
            display: none;
        }

        .feedback.correct {
            background: #d4edda;
            color: #155724;
            display: block;
        }

        .feedback.incorrect {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }

        .hidden {
            display: none;
        }

        .selection-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .selection-card {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .selection-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .selection-card.selected {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3) 0%, rgba(118, 75, 162, 0.3) 100%);
            color: #333;
            border-color: #667eea;
        }

        .selection-card .card-pos {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 2px;
            opacity: 0.7;
        }

        .selection-card .card-value {
            font-size: 18px;
            font-weight: bold;
        }

        .selection-card.selected .card-pos {
            opacity: 1;
        }

        .selection-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .selection-info {
            background: #e3f2fd;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 500;
            color: #1565c0;
        }

        .practice-select {
            padding: 8px 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            background: white;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .practice-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .practice-start {
            text-align: center;
            padding: 40px 20px;
        }

        .start-info h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .start-info p {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .start-btn {
            font-size: 18px;
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .number-text-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 18px;
            text-align: center;
            background: white;
            transition: border-color 0.3s;
        }

        .number-text-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-btn.selected {
            background: #667eea;
            color: white;
        }

        .score-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .score-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .score-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .score-header h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 24px;
        }

        .score-stats {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }

        .score-main {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .score-time {
            font-size: 16px;
            color: #666;
        }

        .incorrect-section {
            margin: 25px 0;
        }

        .incorrect-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .incorrect-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .incorrect-item {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .incorrect-question {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .incorrect-details {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }

        .user-answer {
            color: #e53e3e;
            font-weight: 500;
        }

        .correct-answer {
            color: #38a169;
            font-weight: 500;
        }

        .score-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 25px;
        }

        .perfect-score {
            color: #38a169;
        }

        .hidden {
            display: none !important;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
                max-width: 100%;
            }

            .header h1 {
                font-size: 24px;
                margin-bottom: 15px;
            }

            .nav-buttons {
                flex-wrap: wrap;
                gap: 8px;
                margin-bottom: 20px;
                justify-content: center;
            }

            .nav-btn {
                flex: 1 1 calc(50% - 4px);
                min-width: 120px;
                padding: 10px 8px;
                font-size: 14px;
                text-align: center;
            }

            .card-display {
                padding: 20px;
                min-height: 150px;
                margin-bottom: 15px;
            }

            .position-number {
                font-size: 48px;
            }

            .card-name {
                font-size: 36px;
            }

            .controls {
                flex-direction: column;
                gap: 10px;
            }

            .control-btn {
                width: 100%;
                padding: 12px;
                font-size: 16px;
            }

            .settings {
                padding: 15px;
            }

            .setting-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .selection-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
            }

            .selection-card {
                min-height: 50px;
                padding: 6px;
            }

            .selection-card .card-value {
                font-size: 14px;
            }

            .selection-card .card-pos {
                font-size: 10px;
            }

            .input-grid {
                gap: 8px;
            }

            .input-btn {
                padding: 10px;
                font-size: 14px;
            }

            .number-text-input {
                padding: 12px;
                font-size: 16px;
            }

            .score-content {
                padding: 20px;
                margin: 10px;
            }

            .score-header h2 {
                font-size: 20px;
            }

            .score-main {
                font-size: 24px;
            }

            .score-actions {
                flex-direction: column;
                gap: 10px;
            }

            .score-actions .control-btn {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 8px;
            }

            .nav-buttons {
                gap: 6px;
            }

            .nav-btn {
                flex: 1 1 calc(50% - 3px);
                min-width: 100px;
                padding: 8px 6px;
                font-size: 13px;
            }

            .card-display {
                padding: 15px;
                min-height: 120px;
            }

            .position-number {
                font-size: 36px;
            }

            .card-name {
                font-size: 28px;
            }

            .selection-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
            }

            .selection-card {
                min-height: 45px;
                padding: 4px;
            }

            .selection-card .card-value {
                font-size: 12px;
            }

            .input-grid {
                gap: 6px;
            }

            .input-btn {
                padding: 8px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Mnemonica Stack Trainer</h1>
        </div>

        <div class="nav-buttons">
            <button class="nav-btn active" id="learnBtn">Learn</button>
            <button class="nav-btn" id="practiceBtn">Practice</button>
            <button class="nav-btn" id="selectionBtn">Selection</button>
            <button class="nav-btn" id="statsBtn">Statistics</button>
        </div>

        <!-- Learn Mode -->
        <div id="learn" class="mode-content active">
            <div class="settings">
                <div class="setting-row">
                    <span>Show Number First</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="showNumberFirst" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-row">
                    <span>Random Order</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="randomOrder">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="card-display" id="learnCard">
                <div id="learnDisplay"></div>
            </div>

            <div class="progress-bar">
                <div id="learnProgress" class="progress-fill"></div>
            </div>

            <div class="controls">
                <button class="control-btn" id="prevBtn">← Previous</button>
                <button class="control-btn" id="nextBtn">Next →</button>
            </div>
        </div>

        <!-- Practice Mode -->
        <div id="practice" class="mode-content">
            <div class="settings">
                <div class="setting-row">
                    <span>Practice Type</span>
                    <select id="practiceType" class="practice-select">
                        <option value="numberFromCard">Guess Number from Card</option>
                        <option value="cardFromNumber">Guess Card from Number</option>
                        <option value="hybrid">Hybrid (Random)</option>
                    </select>
                </div>
            </div>

            <div id="practiceStart" class="practice-start">
                <div class="start-info">
                    <h3>Ready to Practice?</h3>
                    <p>Click Start to begin your practice session with the selected cards.</p>
                </div>
                <button class="control-btn start-btn" id="startPracticeBtn">Start Practice</button>
            </div>

            <div id="practiceSession" class="hidden">
                <div class="timer" id="timer">00:00</div>

                <div class="card-display">
                    <div id="practiceQuestion"></div>
                </div>

                <div class="progress-bar">
                    <div id="practiceProgress" class="progress-fill"></div>
                </div>

                <div id="feedback" class="feedback"></div>

                <div id="numberInput" class="hidden">
                    <input type="number" id="numberTextInput" class="number-text-input" placeholder="Enter position (1-52)" min="1" max="52">
                </div>

                <div id="cardInput" class="hidden">
                    <div style="margin-bottom: 10px;">
                        <div class="input-grid" style="grid-template-columns: repeat(5, 1fr);">
                            <button class="input-btn rank-btn" data-rank="A">A</button>
                            <button class="input-btn rank-btn" data-rank="2">2</button>
                            <button class="input-btn rank-btn" data-rank="3">3</button>
                            <button class="input-btn rank-btn" data-rank="4">4</button>
                            <button class="input-btn rank-btn" data-rank="5">5</button>
                            <button class="input-btn rank-btn" data-rank="6">6</button>
                            <button class="input-btn rank-btn" data-rank="7">7</button>
                            <button class="input-btn rank-btn" data-rank="8">8</button>
                            <button class="input-btn rank-btn" data-rank="9">9</button>
                            <button class="input-btn rank-btn" data-rank="10">10</button>
                            <button class="input-btn rank-btn" data-rank="J">J</button>
                            <button class="input-btn rank-btn" data-rank="Q">Q</button>
                            <button class="input-btn rank-btn" data-rank="K">K</button>
                        </div>
                    </div>
                    <div class="input-grid">
                        <button class="input-btn suit-btn red" data-suit="♥">♥</button>
                        <button class="input-btn suit-btn red" data-suit="♦">♦</button>
                        <button class="input-btn suit-btn black" data-suit="♣">♣</button>
                        <button class="input-btn suit-btn black" data-suit="♠">♠</button>
                    </div>
                    <div style="text-align: center; margin-top: 10px;">
                        <span style="font-size: 36px; font-weight: bold;" id="cardDisplay"></span>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button class="control-btn" id="submitCardBtn">Submit</button>
                    </div>
                </div>

                <div class="controls" style="margin-top: 30px;">
                    <button class="control-btn" id="showAnswerBtn">Show Answer</button>
                    <button class="control-btn" id="restartBtn">Restart</button>
                </div>
            </div>
        </div>

        <!-- Score Summary Modal -->
        <div id="scoreSummary" class="score-modal hidden">
            <div class="score-content">
                <div class="score-header">
                    <h2>Practice Session Complete!</h2>
                    <div class="score-stats">
                        <div class="score-main">
                            <span id="scoreText">0/0</span>
                            <span id="scorePercent">(0%)</span>
                        </div>
                        <div class="score-time">
                            Time: <span id="sessionTime">00:00</span>
                        </div>
                    </div>
                </div>
                
                <div id="incorrectAnswers" class="incorrect-section">
                    <h3>Incorrect Answers:</h3>
                    <div id="incorrectList" class="incorrect-list">
                        <!-- Incorrect answers will be populated here -->
                    </div>
                </div>
                
                <div class="score-actions">
                    <button class="control-btn" id="practiceAgainBtn">Practice Again</button>
                    <button class="control-btn" id="closeScoreBtn">Close</button>
                </div>
            </div>
        </div>

        <!-- Selection Mode -->
        <div id="selection" class="mode-content">
            <div class="selection-info">
                <span id="selectionCount">52 of 52 cards selected</span>
            </div>
            
            <div class="selection-controls">
                <button class="control-btn" id="selectAllBtn">Select All</button>
                <button class="control-btn" id="selectNoneBtn">Select None</button>
            </div>
            
            <div class="selection-grid" id="selectionGrid">
                <!-- Cards will be populated by JavaScript -->
            </div>
        </div>

        <!-- Statistics -->
        <div id="stats" class="mode-content">
            <div class="stats-container">
                <div class="stat-row">
                    <span class="stat-label">Sessions Completed</span>
                    <span class="stat-value" id="sessionsCompleted">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Best Time</span>
                    <span class="stat-value" id="bestTime">--:--</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Average Time</span>
                    <span class="stat-value" id="avgTime">--:--</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Total Correct</span>
                    <span class="stat-value" id="totalCorrect">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Total Attempts</span>
                    <span class="stat-value" id="totalAttempts">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Accuracy</span>
                    <span class="stat-value" id="accuracy">0%</span>
                </div>
            </div>
            <div class="controls" style="margin-top: 20px;">
                <button class="control-btn" id="clearStatsBtn">Clear Statistics</button>
            </div>
        </div>
    </div>

    <script>
        // Mnemonica Stack
        const mnemonica = [
            {pos: 1, card: '4♣'}, {pos: 2, card: '2♥'}, {pos: 3, card: '7♦'}, {pos: 4, card: '3♣'},
            {pos: 5, card: '4♥'}, {pos: 6, card: '6♦'}, {pos: 7, card: 'A♠'}, {pos: 8, card: '5♥'},
            {pos: 9, card: '9♠'}, {pos: 10, card: '2♠'}, {pos: 11, card: 'Q♥'}, {pos: 12, card: '3♦'},
            {pos: 13, card: 'Q♣'}, {pos: 14, card: '8♥'}, {pos: 15, card: '6♠'}, {pos: 16, card: '5♠'},
            {pos: 17, card: '9♥'}, {pos: 18, card: 'K♣'}, {pos: 19, card: '2♦'}, {pos: 20, card: 'J♥'},
            {pos: 21, card: '3♠'}, {pos: 22, card: '8♠'}, {pos: 23, card: '6♥'}, {pos: 24, card: '10♣'},
            {pos: 25, card: '5♦'}, {pos: 26, card: 'K♦'}, {pos: 27, card: '2♣'}, {pos: 28, card: '3♥'},
            {pos: 29, card: '8♦'}, {pos: 30, card: '5♣'}, {pos: 31, card: 'K♠'}, {pos: 32, card: 'J♦'},
            {pos: 33, card: '8♣'}, {pos: 34, card: '10♠'}, {pos: 35, card: 'K♥'}, {pos: 36, card: 'J♣'},
            {pos: 37, card: '7♠'}, {pos: 38, card: '10♥'}, {pos: 39, card: 'A♦'}, {pos: 40, card: '4♠'},
            {pos: 41, card: '7♥'}, {pos: 42, card: '4♦'}, {pos: 43, card: 'A♣'}, {pos: 44, card: '9♣'},
            {pos: 45, card: 'J♠'}, {pos: 46, card: 'Q♦'}, {pos: 47, card: '7♣'}, {pos: 48, card: 'Q♠'},
            {pos: 49, card: '10♦'}, {pos: 50, card: '6♣'}, {pos: 51, card: 'A♥'}, {pos: 52, card: '9♦'}
        ];

        // Global variables
        let currentMode = 'learn';
        let learnIndex = 0;
        let learnOrder = [...Array(52).keys()];
        let showingFront = true;
        let practiceIndex = 0;
        let practiceOrder = [];
        let startTime = null;
        let timerInterval = null;
        let selectedRank = '';
        let selectedSuit = '';
        let currentInputNumber = '';
        let practiceStarted = false;
        let currentPracticeType = 'hybrid';
        let awaitingAnswer = false;
        let sessionResults = [];
        let sessionCorrect = 0;
        let sessionTotal = 0;
        let stats = {sessions: 0, bestTime: null, totalTime: 0, correct: 0, attempts: 0};
        
        // Card selection variables
        let selectedCards = new Set([...Array(52).keys()]); // All cards selected by default
        let availableCards = []; // Filtered list of selected card indices

        // Load stats from memory
        try {
            const saved = JSON.parse(localStorage.getItem('mnemonicaStats') || '{}');
            if (saved.sessions !== undefined) stats = saved;
        } catch (e) {
            console.log('Could not load stats');
        }

        // Mode switching
        document.getElementById('learnBtn').addEventListener('click', () => switchMode('learn'));
        document.getElementById('practiceBtn').addEventListener('click', () => switchMode('practice'));
        document.getElementById('selectionBtn').addEventListener('click', () => switchMode('selection'));
        document.getElementById('statsBtn').addEventListener('click', () => switchMode('stats'));

        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.mode-content').forEach(content => content.classList.remove('active'));
            
            document.getElementById(mode + 'Btn').classList.add('active');
            document.getElementById(mode).classList.add('active');
            
            if (mode === 'practice') {
                // Reset practice mode to start screen
                practiceStarted = false;
                awaitingAnswer = false;
                if (timerInterval) clearInterval(timerInterval);
                document.getElementById('practiceStart').classList.remove('hidden');
                document.getElementById('practiceSession').classList.add('hidden');
                document.getElementById('timer').textContent = '00:00';
            } else if (mode === 'stats') {
                updateStats();
            } else if (mode === 'selection') {
                initializeSelection();
            }
        }

        // Selection Mode Functions
        function initializeSelection() {
            populateSelectionGrid();
            updateSelectionInfo();
        }

        function populateSelectionGrid() {
            const grid = document.getElementById('selectionGrid');
            grid.innerHTML = '';
            
            mnemonica.forEach((card, index) => {
                const cardElement = document.createElement('div');
                cardElement.className = `selection-card ${selectedCards.has(index) ? 'selected' : ''}`;
                cardElement.dataset.index = index;
                
                const rank = card.card.slice(0, -1);
                const suit = card.card.slice(-1);
                const isRed = suit === '♥' || suit === '♦';
                
                cardElement.innerHTML = `
                    <div class="card-pos">${card.pos}</div>
                    <div class="card-value ${isRed ? 'red' : 'black'}">${card.card}</div>
                `;
                
                cardElement.addEventListener('click', () => toggleCard(index));
                grid.appendChild(cardElement);
            });
        }

        function toggleCard(index) {
            if (selectedCards.has(index)) {
                selectedCards.delete(index);
            } else {
                selectedCards.add(index);
            }
            
            updateSelectionDisplay(index);
            updateSelectionInfo();
            updateAvailableCards();
        }

        function updateSelectionDisplay(index) {
            const cardElement = document.querySelector(`[data-index="${index}"]`);
            if (selectedCards.has(index)) {
                cardElement.classList.add('selected');
            } else {
                cardElement.classList.remove('selected');
            }
        }

        function updateSelectionInfo() {
            const count = selectedCards.size;
            document.getElementById('selectionCount').textContent = `${count} of 52 cards selected`;
        }

        function updateAvailableCards() {
            availableCards = Array.from(selectedCards).sort((a, b) => a - b);
            
            // Reset learn and practice indices if they're out of bounds
            if (availableCards.length > 0) {
                if (learnIndex >= availableCards.length) {
                    learnIndex = 0;
                }
                if (practiceIndex >= availableCards.length) {
                    practiceIndex = 0;
                }
            }
        }

        // Selection control buttons
        document.getElementById('selectAllBtn').addEventListener('click', () => {
            selectedCards = new Set([...Array(52).keys()]);
            populateSelectionGrid();
            updateSelectionInfo();
            updateAvailableCards();
        });

        document.getElementById('selectNoneBtn').addEventListener('click', () => {
            selectedCards = new Set();
            populateSelectionGrid();
            updateSelectionInfo();
            updateAvailableCards();
        });



        function formatCard(card) {
            const rank = card.slice(0, -1);
            const suit = card.slice(-1);
            const isRed = suit === '♥' || suit === '♦';
            return `<div class="card-value">
                <span class="rank ${isRed ? 'red' : 'black'}">${rank}</span>
                <span class="suit ${isRed ? 'red' : 'black'}">${suit}</span>
            </div>`;
        }

        // Learn Mode Functions
        function updateLearnDisplay() {
            if (availableCards.length === 0) {
                const display = document.getElementById('learnDisplay');
                display.innerHTML = '<div style="color: #666; font-size: 18px;">No cards selected.<br>Go to Selection to choose cards.</div>';
                return;
            }
            
            const showNumberFirst = document.getElementById('showNumberFirst').checked;
            const currentCardIndex = availableCards[learnIndex];
            const current = mnemonica[currentCardIndex];
            const display = document.getElementById('learnDisplay');
            
            if (showingFront) {
                if (showNumberFirst) {
                    display.innerHTML = `<div class="position-number">${current.pos}</div>`;
                } else {
                    display.innerHTML = formatCard(current.card);
                }
            } else {
                if (showNumberFirst) {
                    display.innerHTML = formatCard(current.card);
                } else {
                    display.innerHTML = `<div class="position-number">${current.pos}</div>`;
                }
            }
            
            updateProgress();
        }

        document.getElementById('learnCard').addEventListener('click', () => {
            showingFront = !showingFront;
            updateLearnDisplay();
        });

        document.getElementById('nextBtn').addEventListener('click', () => {
            if (availableCards.length === 0) return;
            
            learnIndex = (learnIndex + 1) % availableCards.length;
            showingFront = true;
            
            if (document.getElementById('randomOrder').checked && learnIndex === 0) {
                shuffleLearnOrder();
            }
            
            updateLearnDisplay();
        });

        document.getElementById('prevBtn').addEventListener('click', () => {
            if (availableCards.length === 0) return;
            
            learnIndex = (learnIndex - 1 + availableCards.length) % availableCards.length;
            showingFront = true;
            updateLearnDisplay();
        });

        function shuffleLearnOrder() {
            // Shuffle the available cards array
            for (let i = availableCards.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [availableCards[i], availableCards[j]] = [availableCards[j], availableCards[i]];
            }
        }

        function updateProgress() {
            if (availableCards.length === 0) {
                document.getElementById('learnProgress').style.width = '0%';
                return;
            }
            const progress = ((learnIndex + 1) / availableCards.length) * 100;
            document.getElementById('learnProgress').style.width = `${progress}%`;
        }

        function updatePracticeProgress() {
            if (practiceOrder.length === 0) {
                document.getElementById('practiceProgress').style.width = '0%';
                return;
            }
            const progress = ((practiceIndex + 1) / practiceOrder.length) * 100;
            document.getElementById('practiceProgress').style.width = `${progress}%`;
        }

        document.getElementById('randomOrder').addEventListener('change', (e) => {
            if (e.target.checked) {
                shuffleLearnOrder();
            } else {
                updateAvailableCards(); // Reset to original order
            }
            learnIndex = 0;
            showingFront = true;
            updateLearnDisplay();
        });

        document.getElementById('showNumberFirst').addEventListener('change', () => {
            showingFront = true;
            updateLearnDisplay();
        });

        // Keyboard shortcuts for learn mode
        document.addEventListener('keydown', (e) => {
            // Only handle keyboard shortcuts when in learn mode
            if (currentMode !== 'learn') return;
            
            switch(e.key) {
                case 'ArrowLeft':
                    e.preventDefault();
                    document.getElementById('prevBtn').click();
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    document.getElementById('nextBtn').click();
                    break;
                case ' ': // Spacebar
                    e.preventDefault();
                    document.getElementById('learnCard').click();
                    break;
            }
        });

        // Practice Mode Functions
        function startPractice() {
            if (availableCards.length === 0) {
                document.getElementById('practiceStart').innerHTML = '<div style="color: #666; font-size: 18px; text-align: center;">No cards selected.<br>Go to Selection to choose cards.</div>';
                return;
            }
            
            practiceStarted = true;
            practiceIndex = 0;
            currentPracticeType = document.getElementById('practiceType').value;
            
            // Initialize session tracking
            sessionResults = [];
            sessionCorrect = 0;
            sessionTotal = 0;
            
            // Shuffle available cards
            practiceOrder = [...availableCards];
            for (let i = practiceOrder.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [practiceOrder[i], practiceOrder[j]] = [practiceOrder[j], practiceOrder[i]];
            }
            
            // Hide start screen, show practice session
            document.getElementById('practiceStart').classList.add('hidden');
            document.getElementById('practiceSession').classList.remove('hidden');
            
            // Start timer
            startTime = Date.now();
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 100);
            
            document.getElementById('feedback').style.display = 'none';
            updatePracticeProgress();
            showPracticeQuestion();
        }

        function showPracticeQuestion() {
            if (practiceIndex >= practiceOrder.length) {
                endPractice();
                return;
            }
            
            const current = mnemonica[practiceOrder[practiceIndex]];
            const question = document.getElementById('practiceQuestion');
            awaitingAnswer = true;
            
            // Clear previous inputs and selections
            document.getElementById('numberTextInput').value = '';
            document.getElementById('cardDisplay').textContent = '';
            clearCardSelections();
            selectedRank = '';
            selectedSuit = '';
            
            document.getElementById('feedback').style.display = 'none';
            
            // Determine question type based on practice mode
            let askForNumber;
            if (currentPracticeType === 'numberFromCard') {
                askForNumber = true;
            } else if (currentPracticeType === 'cardFromNumber') {
                askForNumber = false;
            } else { // hybrid
                askForNumber = Math.random() < 0.5;
            }
            
            if (askForNumber) {
                question.innerHTML = formatCard(current.card);
                document.getElementById('numberInput').classList.remove('hidden');
                document.getElementById('cardInput').classList.add('hidden');
                document.getElementById('numberTextInput').focus();
            } else {
                question.innerHTML = `<div class="position-number">${current.pos}</div>`;
                document.getElementById('numberInput').classList.add('hidden');
                document.getElementById('cardInput').classList.remove('hidden');
            }
        }

        function clearCardSelections() {
            document.querySelectorAll('.rank-btn, .suit-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
        }

        function submitAnswer() {
            if (!awaitingAnswer) return;
            
            const current = mnemonica[practiceOrder[practiceIndex]];
            let correct = false;
            let userAnswer = '';
            let questionType = '';
            let questionText = '';
            let correctAnswer = '';
            
            if (!document.getElementById('numberInput').classList.contains('hidden')) {
                // Number guessing mode
                questionType = 'numberFromCard';
                questionText = `What position is ${current.card}?`;
                const inputValue = parseInt(document.getElementById('numberTextInput').value);
                userAnswer = inputValue ? `${inputValue}` : 'No answer';
                correctAnswer = `${current.pos}`;
                correct = inputValue === current.pos;
            } else {
                // Card guessing mode
                questionType = 'cardFromNumber';
                questionText = `What card is ${current.pos}?`;
                userAnswer = (selectedRank && selectedSuit) ? selectedRank + selectedSuit : 'No answer';
                correctAnswer = current.card;
                correct = userAnswer === current.card && selectedRank && selectedSuit;
            }
            
            // Track session results
            sessionTotal++;
            const result = {
                questionType,
                questionText,
                userAnswer,
                correctAnswer,
                correct,
                card: current.card,
                position: current.pos
            };
            sessionResults.push(result);
            
            if (correct) {
                sessionCorrect++;
            }
            
            awaitingAnswer = false;
            stats.attempts++;
            
            if (correct) {
                stats.correct++;
                showFeedback(true, `Correct!`);
            } else {
                const feedbackAnswer = questionType === 'numberFromCard' 
                    ? `Position ${current.pos}` 
                    : current.card;
                showFeedback(false, `Incorrect. The answer is ${feedbackAnswer}`);
            }
            
            setTimeout(() => {
                practiceIndex++;
                updatePracticeProgress();
                showPracticeQuestion();
            }, 1500);
        }

        function showAnswerAndAdvance() {
            if (!awaitingAnswer) return;
            
            const current = mnemonica[practiceOrder[practiceIndex]];
            let questionType = '';
            let questionText = '';
            let correctAnswer = '';
            let displayAnswer = '';
            
            // If number input is visible, user is guessing the position number
            if (!document.getElementById('numberInput').classList.contains('hidden')) {
                questionType = 'numberFromCard';
                questionText = `What position is ${current.card}?`;
                correctAnswer = `${current.pos}`;
                displayAnswer = `The position is ${current.pos}`;
            } else {
                // If card input is visible, user is guessing the card
                questionType = 'cardFromNumber';
                questionText = `What card is at position ${current.pos}?`;
                correctAnswer = current.card;
                displayAnswer = `The card is ${current.card}`;
            }
            
            // Track session results (user skipped/showed answer)
            sessionTotal++;
            const result = {
                questionType,
                questionText,
                userAnswer: 'Skipped (showed answer)',
                correctAnswer,
                correct: false,
                card: current.card,
                position: current.pos
            };
            sessionResults.push(result);
            
            awaitingAnswer = false;
            stats.attempts++;
            
            // Show the answer with neutral styling
            const feedback = document.getElementById('feedback');
            feedback.textContent = displayAnswer;
            feedback.className = 'feedback';
            feedback.style.display = 'block';
            feedback.style.background = '#e3f2fd';
            feedback.style.color = '#1565c0';
            
            setTimeout(() => {
                practiceIndex++;
                updatePracticeProgress();
                showPracticeQuestion();
            }, 2500);
        }

        // Practice mode event listeners
        document.getElementById('startPracticeBtn').addEventListener('click', startPractice);
        
        // Number input handler (Enter key submission)
        document.getElementById('numberTextInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                submitAnswer();
            }
        });
        
        // Global keydown handler for practice mode
        document.addEventListener('keydown', (e) => {
            if (currentMode === 'practice' && practiceStarted && awaitingAnswer && e.key === 'Enter') {
                e.preventDefault();
                submitAnswer();
            }
        });

        // Card input handlers
        document.querySelectorAll('.rank-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                // Clear previous rank selection
                document.querySelectorAll('.rank-btn').forEach(b => b.classList.remove('selected'));
                
                selectedRank = e.target.dataset.rank;
                e.target.classList.add('selected');
                updateCardDisplay();
            });
        });

        document.querySelectorAll('.suit-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                // Clear previous suit selection
                document.querySelectorAll('.suit-btn').forEach(b => b.classList.remove('selected'));
                
                selectedSuit = e.target.dataset.suit;
                e.target.classList.add('selected');
                updateCardDisplay();
            });
        });

        function updateCardDisplay() {
            const display = document.getElementById('cardDisplay');
            if (selectedRank && selectedSuit) {
                const isRed = selectedSuit === '♥' || selectedSuit === '♦';
                display.innerHTML = `<span class="${isRed ? 'red' : 'black'}">${selectedRank}${selectedSuit}</span>`;
            } else {
                display.textContent = '';
            }
        }

        // Submit card button handler
        document.getElementById('submitCardBtn').addEventListener('click', submitAnswer);

        document.getElementById('showAnswerBtn').addEventListener('click', showAnswerAndAdvance);

        document.getElementById('restartBtn').addEventListener('click', () => {
            // Reset practice state
            practiceStarted = false;
            awaitingAnswer = false;
            if (timerInterval) clearInterval(timerInterval);
            
            // Show start screen, hide practice session
            document.getElementById('practiceStart').classList.remove('hidden');
            document.getElementById('practiceSession').classList.add('hidden');
            
            // Reset timer display
            document.getElementById('timer').textContent = '00:00';
        });

        // Score summary modal event listeners
        document.getElementById('practiceAgainBtn').addEventListener('click', () => {
            hideScoreSummary();
            startPractice();
        });

        document.getElementById('closeScoreBtn').addEventListener('click', () => {
            hideScoreSummary();
            // Reset practice state and show start screen
            practiceStarted = false;
            awaitingAnswer = false;
            if (timerInterval) clearInterval(timerInterval);
            document.getElementById('practiceStart').classList.remove('hidden');
            document.getElementById('practiceSession').classList.add('hidden');
            document.getElementById('timer').textContent = '00:00';
        });

        function showFeedback(correct, message) {
            const feedback = document.getElementById('feedback');
            feedback.textContent = message;
            feedback.className = `feedback ${correct ? 'correct' : 'incorrect'}`;
        }

        function endPractice() {
            clearInterval(timerInterval);
            const elapsed = Date.now() - startTime;
            
            stats.sessions++;
            stats.totalTime += elapsed;
            if (!stats.bestTime || elapsed < stats.bestTime) {
                stats.bestTime = elapsed;
            }
            
            saveStats();
            showScoreSummary(elapsed);
        }

        function showScoreSummary(elapsed) {
            // Update score display
            const percentage = sessionTotal > 0 ? Math.round((sessionCorrect / sessionTotal) * 100) : 0;
            document.getElementById('scoreText').textContent = `${sessionCorrect}/${sessionTotal}`;
            document.getElementById('scorePercent').textContent = `(${percentage}%)`;
            document.getElementById('sessionTime').textContent = formatTime(elapsed);
            
            // Update score color based on performance
            const scoreMain = document.querySelector('.score-main');
            if (percentage === 100) {
                scoreMain.classList.add('perfect-score');
            } else {
                scoreMain.classList.remove('perfect-score');
            }
            
            // Populate incorrect answers
            const incorrectList = document.getElementById('incorrectList');
            const incorrectSection = document.getElementById('incorrectAnswers');
            const incorrectAnswers = sessionResults.filter(result => !result.correct);
            
            if (incorrectAnswers.length === 0) {
                incorrectSection.style.display = 'none';
            } else {
                incorrectSection.style.display = 'block';
                incorrectList.innerHTML = '';
                
                incorrectAnswers.forEach(result => {
                    const item = document.createElement('div');
                    item.className = 'incorrect-item';
                    
                    item.innerHTML = `
                        <div class="incorrect-question">${result.questionText}</div>
                        <div class="incorrect-details">
                            <span class="user-answer">Your answer: ${result.userAnswer}</span>
                            <span class="correct-answer">Correct: ${result.correctAnswer}</span>
                        </div>
                    `;
                    
                    incorrectList.appendChild(item);
                });
            }
            
            // Show the modal
            document.getElementById('scoreSummary').classList.remove('hidden');
        }

        function hideScoreSummary() {
            document.getElementById('scoreSummary').classList.add('hidden');
        }

        function updateTimer() {
            if (!startTime) return;
            const elapsed = Date.now() - startTime;
            document.getElementById('timer').textContent = formatTime(elapsed);
        }

        function formatTime(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Statistics Functions
        function updateStats() {
            document.getElementById('sessionsCompleted').textContent = stats.sessions;
            document.getElementById('bestTime').textContent = stats.bestTime ? formatTime(stats.bestTime) : '--:--';
            document.getElementById('avgTime').textContent = stats.sessions > 0 ? formatTime(stats.totalTime / stats.sessions) : '--:--';
            document.getElementById('totalCorrect').textContent = stats.correct;
            document.getElementById('totalAttempts').textContent = stats.attempts;
            document.getElementById('accuracy').textContent = stats.attempts > 0 ? 
                `${Math.round((stats.correct / stats.attempts) * 100)}%` : '0%';
        }

        function saveStats() {
            try {
                localStorage.setItem('mnemonicaStats', JSON.stringify(stats));
            } catch (e) {
                console.log('Could not save stats');
            }
            updateStats();
        }

        document.getElementById('clearStatsBtn').addEventListener('click', () => {
            if (confirm('Are you sure you want to clear all statistics?')) {
                stats = {sessions: 0, bestTime: null, totalTime: 0, correct: 0, attempts: 0};
                saveStats();
            }
        });

        // Initialize
        updateAvailableCards(); // Initialize availableCards with all selected cards
        updateLearnDisplay();
    </script>
</body>
</html>